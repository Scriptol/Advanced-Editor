<!--
Advanced Editor  
(c) 2016-2017 Denis Sureau
License Creative Common

Based on Advanced Explorer JE (c) 2012-2017 D. Sureau

Make use of:
* Ace Editor API, under the BSD Licence.
* Tango public domain icons.
-->
<html lang="en">
<head>
<title>Advanced Editor</title>
<link type="text/css" href="code/aedit.css" rel="stylesheet">
<script src="src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="code/javascript-ini.js"></script>    
<script src="aedit.ini.js"></script>        
</head>
<body>
<div id="toolbar">
<div class="imagebutton" id="load" onClick="act(this)"><img class="image" src="images/open.png" alt="Load" title="Load a file"></div>
<div class="imagebutton" id="save" onClick="act(this)"><img class="image" src="images/save.png" alt="Save" title="Save to file"></div>
<div class="imagebutton" id="new"  onClick="act(this)"><img class="image" src="images/new.png" alt="New blank page" title="New blank page"></div>
<div class="imagebutton" id="find" onClick="act(this)"><img class="image" src="images/find.png" alt="Search" title="Search  CTRL-F"></div>
<div class="imagebutton" id="replace" onClick="act(this)"><img class="image" src="images/replace.png" alt="Search & replace" title="Search & replace  CTRL-H"></div>

<div class="imagebutton" id="go">
    <div class="insert">
        <img class="image" src="images/go.png" alt="Go to location" title="Go to location">
   <span id="golist" class="comlist">
  <h3>Go to...</h3>
    <p id="top" class='prjIna' title="" onmouseover='setAct(this)' onmouseout='setIna(this)' onclick='act(this)'>Top</p>   
    <p id="bottom" class='prjIna' title="" onmouseover='setAct(this)' onmouseout='setIna(this)' onclick='act(this)'>Bottom</p>
   </span>    
  </div>  
</div> 

<div class="buttonInput" id="line"  alt="Go to line" title="Go to line">
   <input id="line" type="text" size="4" value="" onKeyUp="goline(this)">
</div>

<div class="imagebutton" id="outdent" onClick="act(this)"><img class="image" src="images/outdent.png" alt="Outdent" title="Unindent  SHIFT-TAB"></div>
<div class="imagebutton" id="indent"  onClick="act(this)"><img class="image" src="images/indent.png" alt="Indent" title="Indent  TAB"></div>

<div class="imagebutton" id="cutico">
<div class="insert">
  <img class="image" src="images/cut.png" alt="Cut/paste" title="Copy/Paste">
  <span class="comlist">
  <h3>Copy/Paste</h3>
  <p id="cut" class='prjIna' title="" onmouseover='setAct(this)' onmouseout='setIna(this)' onclick='act(this)'>Cut  <span class="shortcut">CTRL-X</span></p>   
  <p id="copy" class='prjIna' title="" onmouseover='setAct(this)' onmouseout='setIna(this)' onclick='act(this)'>Copy  <span class="shortcut">CTRL-C</span></p> 
  <p id="paste" class='prjIna' title="" onmouseover='setAct(this)' onmouseout='setIna(this)' onclick='act(this)'>Paste  <span class="shortcut">CTRL-V</span></p> 
  </span>
 </div>
</div>    
    
<div class="imagebutton" id="undo"    onClick="act(this)"><img class="image" src="images/undo.png" alt="Undo" title="Undo  CTRL-Z"></div>
<div class="imagebutton" id="redo"    onClick="act(this)"><img class="image" src="images/redo.png" alt="Redo" title="Redo   CTRL-Y"></div>
<div class="imagebutton" id="insico">
 <div class="insert">
   <img class="image" src="images/insert.png" alt="Insert elements" title="Insert elements">
  <span class="comlist">
  <h3>Insert</h3>
  <p id="comment" class='prjIna' title="" onmouseover='setAct(this)' onmouseout='setIna(this)' onclick='act(this)'>/* */</p>  
  <p id="nocomment" class='prjIna' title="" onmouseover='setAct(this)' onmouseout='setIna(this)' onclick='act(this)'>No /* */</p>         
  <p id="link" class='prjIna' title="" onmouseover='setAct(this)' onmouseout='setIna(this)' onclick='act(this)'>Link</p>   
  <p id="table" class='prjIna' title="" onmouseover='setAct(this)' onmouseout='setIna(this)' onclick='act(this)'>Table</p>         
 </span>    
 </div>  
</div>    
<div class="imagebutton" id="preview" onClick="act(this)">
  <img src="images/preview.png" width="32" height="32" title="Preview document">
</div>    
<div class="imagebutton" id="about" onClick="act(this)">
  <img src="images/help.png" id='thelp' width="32" height="32" title="About AEdit">
</div>
<div class="imagebutton" id='quit'   onClick="act(this)"><img class="image" src="images/exit.png" alt="Exit" title="Close the editor"></div>

<div class="sideright">
  <div class="tfield" id="filename"></div>
  <div class="indicator"><img class="image" id="changed" src="images/saved.png" alt="Change status" title="On if modified"></div>
</div>
</div> <!--toolbar-->

<div id="main">
    <div id="project">
        <div id="prjbar">
            <img class="pimage" src="images/prjadd.png" title="Add file to current project" onclick="addFileToList()">
            <img class="pimage" src="images/prjrem.png" title="Remove selected file from project"  onclick="removeFileFromPrj()">
            <img class="primage" src="images/prjexit.png" title="Close the project" onclick="closeProject()">
        </div>
        <div id="prjlist"></div>
        <div id="allprjs">
              <div id="prjSet">
                <div id="currprj"></div>
                <span id="listOfPrj">
                <h3>Projects</h3>
                </span>    
              </div>  
        </div>
        </div>
    <div id="epanel">
        <div id="editor"></div>
        <div id="statusbar">
            <div id="statustext"></div>
        </div>
    </div>
    <div id="lpanel">
        <iframe id="loader" src="loader.html" width="640" height="500"></iframe>
    </div>      
    <div id="opanel">
        <iframe id="options" src="settings.html" width="640" height="500"></iframe>
    </div>
    <div id="apanel">
        <iframe id="manual" src="manual.html" width="640" height="500"></iframe>
    </div>
</div> <!--main-->
    
<dialog id="sDialog">
  <menu>
    <button onclick="sDialog.close(2)">Save</button>
    <button onclick="sDialog.close(1)">Do not save</button>
    <button onclick="sDialog.close(0)">Cancel</button>
  </menu>
</dialog>    
    
<script>
const {dialog} = require('electron').remote   

var aPanel = document.getElementById("apanel")
var ePanel = document.getElementById("epanel")
var lPanel = document.getElementById("lpanel")
var oPanel = document.getElementById("opanel")
    
var contentToSave = false;
var editor = ace.edit("editor");
var project = [];
var rootdir;
    
var languageExt = {
  "c": "c_cpp",
  "cpp": "c_cpp",
  "cs": "csharp",  
  "css": "css",
  "go": "golang",  
  "h": "c_cpp",
  "hpp": "c_cpp",  
  "ini": "ini",
  "java": "java",
  "jl": "julia",
  "js": "javascript",
  "json": "json",
  "html": "html",
  "php": "php",  
  "rss": "xml",
  "svg": "svg",      
  "py": "python",
  "rb": "ruby",
  "sql": "sql",  
  "txt": "plain_text",                
  "xml": "xml"  
};
    

editor.setTheme("ace/theme/dreamweaver");
editor.getSession().setMode("ace/mode/html"); 
editor.getSession().on('change', function() { 
    if(contentToSave == false)
       changedStatus(true);
    }
);
		
editor.commands.addCommand({
    	name: 'saving',
    	bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
    	exec: function(editor) { 
            save(false); 
        }
	},{
    name: "find",
    bindKey: {win: "Ctrl-F", mac: "Command-F"},
    exec: function(editor, needle) {
        if (typeof needle == "object") {
            var arg = this.name + " " + editor.getCopyText()
            editor.cmdLine.setValue(arg, 1)
            editor.cmdLine.focus()
            return
        }
        editor.find(needle);
    	}
	},{
    name: "gotoline",
    bindKey: {win: "Ctrl-L", mac: "Command-L"},
    exec: function(editor, line) {
        if (typeof line == "object") {
            var arg = this.name + " " + editor.getCursorPosition().row;
            editor.cmdLine.setValue(arg, 1)
            editor.cmdLine.focus()
            return
        }
        line = parseInt(line, 10);
        if (!isNaN(line))
            editor.gotoLine(line);
    	}
	}
	);	
    
    
function sendFromInterface(a) {
    ipcRenderer.send("interface", JSON.stringify(a));
}


function updateStatusBar(message) {
    document.getElementById('statustext').innerHTML = message;
}

function getActiveRow() {
    if(project==null) return;
    for(var i = 0; i < project.list.length; i++) {
        if(AEditFileName == project.list[i][0])  
            return project.list[i][1];
    }
    return 0;
}

function setActiveRow() {     
    if(AEditFileName == undefined || AEditFileName == "") return;
    if(!(project instanceof Object)) return;
    if("list" in project) {
        for(var i = 0; i < project.list.length; i++)  {
            if(AEditFileName == project.list[i][0]) {
                project.list[i][1] = editor.getFirstVisibleRow();
                return;
            }  
        }
    }
}     
    
function getFileNode() {
    var fname = AEditFileName;    
    if(AEditFileName !="") {
        var pos = fname.lastIndexOf("/");
        if(pos == -1) pos = fname.lastIndexOf("\\");
        if(pos > 0) fname = fname.substr(pos + 1);
    }
    return fname
}    
    
function displayFileName() {
    var fname = getFileNode()
    var fno =  document.getElementById("filename")    
    fno.innerHTML = fname;
    fno.setAttribute("title", AEditFileName);
}

// Prompt to discard content changes
// or open a dialog to select a filename to save
    
    
function AESaveDialog(cb) { 
	var temp = editor.getValue();
	if(temp.length > 0)	{  
        var sDialog = document.createElement("dialog")
        sDialog.id="sDialog"
        document.body.appendChild(sDialog)
        
        var sLabel = document.createElement("p")
        sLabel.innerHTML = "Save changes in " + getFileNode() + "?"
        sDialog.appendChild(sLabel)

        var menu = document.createElement("menu")
        sDialog.appendChild(menu)
        
        var b2 = document.createElement("button")
        b2.onclick=function() { sDialog.close(2) }
        b2.innerHTML="Save"
        menu.appendChild(b2)
        
        var b1 = document.createElement("button")
        b1.onclick=function() { sDialog.close(1) }
        b1.innerHTML="Do not save"
        menu.appendChild(b1)

        var b0 = document.createElement("button")
        b0.onclick=function() { sDialog.close(0) }
        b0.innerHTML="Cancel"
        menu.appendChild(b0)
        //alert(sDialog.innerHTML)
        sDialog.showModal();
        
        sDialog.addEventListener('close', function(e) {
            var response = sDialog.returnValue;
            if(response == 0) {
                cb(false); 
                return;
            }
            if(response == 1) {
                changedStatus(false); 
                cb(true); // do not save and continue
                return;    
            }
            dialog.showSaveDialog(null, {
                title:"Save current text",
                defaultPath: "file:///" + AEditFileName,
                buttonLabel: "Save file and continue"
                }, 
                function(fpath) {
                    document.body.removeChild(sDialog)
                    if(fpath == undefined) {
                        cb(false)  // cancel
                        return;
                    }
                    changedStatus(false);                 
                    AEditFileName = fpath;
                    save(false);
                    cb(true)
                    return;                
            });
        });    
    } 
}


function newDoc() {
    editor.session.setValue("");
    AEditFileName = "";
    displayFileName();
    updateStatusBar("");    
    restartEditor();      
    changedStatus(false);    
}

function clearDoc() {
    if(!contentToSave) {
        newDoc();
        return
    }
    AESaveDialog(function(result) {
        if(result) {
            newDoc();
        }
    });
    return 
}


var project = undefined;

function display(data) {       
    editor.setTheme("ace/theme/" + config.theme.toLowerCase());  
    var fontSize = parseInt(config.fontSize);
    editor.setFontSize(fontSize);
    editor.setShowPrintMargin(false);
    editor.getSession().setTabSize(4);
    editor.getSession().setUseWrapMode(true);
    
    if(data != null && data.content != null) {
        setActiveRow();
        editor.session.setValue(data.content, -1);
        var mode = "plain_text";
        if(data.ext in languageExt)   
        mode = "ace/mode/" + languageExt[data.ext];
        editor.getSession().setMode(mode);    
        AEditFileName = data.filename;
        displayFileName();
        changedStatus(false);
        updateStatusBar(AEditFileName);
        if("project" in data && data.project != null) {
            project = data.project.list;
            config.project = data.project.name;
            editor.scrollToLine(getActiveRow());
            updateProjectName();        
        }
        projectDisplay();  
    }
    editor.focus();
}

/* Project Management */

function getSource(filepath) {
	var a = { 
        'path' : filepath, 
        'command': 'getContent'
    };
    sendFromInterface(a)
}


/* Project */    
    
function extractDir(fullpath) {
    var p1 = fullpath.lastIndexOf("/");
    var p2 = fullpath.lastIndexOf("\\");
    if(p2 > p1) p1 = p2;
    return fullpath.substr(0, p1 + 1);
}

function extractFile(fullpath) {
    var p1 = fullpath.lastIndexOf("/");
    var p2 = fullpath.lastIndexOf("\\");
    if(p2 > p1) p1 = p2;
    return fullpath.substr(p1 + 1);
} 
    
function extractNode(fname) {
    var p = fname.lastIndexOf(".")
    return fname.substr(0, p)
}

/* Project management */    
    
function indexInProject(fname)  {
    for(var i = 0; i < project.list.length; i++) {
        if(project.list[i][0]==fname) return i;
    }
    return -1;
} 
    
var currentInProject = null;    

function addFileToCurrentProject(name) {    
    currentInProject=null;
    if(indexInProject(AEditFileName) != -1) {
        alert("File already in the list!");
        return;
    }
    config.project = name;
    saveIni("aedit.ini.js")     
    updateTooltip();

    project.list.push([AEditFileName, editor.getFirstVisibleRow()]);
    project.list.sort(function (a, b) {
      var af = extractFile(a[0]);
      var bf = extractFile(b[0]);
      return af.localeCompare(bf);
    } );
    projectDisplay();
    currentInProject = AEditFileName;
    saveProject();       
}

    
function createProject() {
    if(project instanceof Object) return true;
    if(config.dir =="/") config.dir=rootdir;
    var fpath = dialog.showSaveDialog(null, {
        title:"Create new project",
        defaultPath: config.dir,
        buttonLabel: "Create project file"
    })
    if(fpath == undefined || fpath.length == 0) return false;
    fpath = canonicalPath(fpath)
    config.dir = extractDir(fpath)
    if(fpath.lastIndexOf(".") == -1) {
        fpath += ".prj";
    }
    ProjectName = fpath;    
    updateProjectName(fpath); 
    project = {};
    project["name"]= fpath;
    project["list"]= [];
    if(!(config.prjList instanceof Array)) {
        config["prjList"] = [];
    } 
    addProject(fpath);
    return true;
}    
   

function projectDisplay() {
    if(!(project instanceof Object)) return;
    var d = document.getElementById("prjlist");
    var content = "";
    for(var i = 0; i < project.list.length; i++) {
        var path = project.list[i][0];
        if(path == undefined || path == "") continue;
        var fname = extractFile(path);
        var flag = (AEditFileName == path);
        content += '<p title="' + path + '" onclick="getSource(this.title)" oncontextmenu="return prjCtxMenu(this)">';
        if(flag)  {
            content += '<b>'+fname+'</b></p>';
            currentInProject = path;
        }
        else {
            content += fname +'</p>';
        }
    }
    d.innerHTML = content;
    var c = document.getElementById("currprj");
    c.innerHTML =  extractNode(extractFile(config.project)).toUpperCase();
    c.setAttribute("title", config.project);
}

function saveProject() {
    if(!(project instanceof Object)) return;
    if(project.list.length == 0) return;
    setActiveRow()
	var a = { 
        'command': 'savePrj',
        'list': project.list,
        'name': config.project,
        'active': AEditFileName
    };
    sendFromInterface(a)
}

function removeFileFromPrj() {
    var fname = currentInProject;
    var pos = indexInProject(fname);
    if(pos == -1) return;
    project.list.splice(pos, 1);    
    currentInProject = null;    
    projectDisplay();
    saveProject();
}


function addFileToList() {
    if(AEditFileName == undefined || AEditFileName == "") {
        alert("Save in a file before to add to a project.")
        return;
    }
    if(createProject() == true) {
        addFileToCurrentProject(config.project);
    }
}
    
    
function updateProjectName(name) {
    if(config.project != name) { 
      config.project = name;
      saveIni("aedit.ini.js")  
    }
}    

function closeProject() {
    project=null;
    updateProjectName("");
    document.getElementById("prjlist").innerHTML="";
    document.getElementById("currprj").innerHTML="";
}
    
function selectProject(elem) {
    var pname = elem.getAttribute("title");
    openProject(pname, true);
}   

function canonicalPath(s){
    s = s.replace(/\\\\/g, '/');    
    return s.replace(/\\/g, '/');
}    
    
function addProject(name) {
    if(config.prjList.indexOf(name) >= 0) {
        return;
    }
    config.prjList.push(name);
    config.prjList.sort(function (a, b) {
        var af = extractFile(a);
        var bf = extractFile(b);
        return af.localeCompare(bf);
    } );    
} 
    
function removeProject(name)  {
    var index = config.prjList.indexOf(name);
    if (index > -1) {
        config.prjList.splice(index, 1);
        updateTooltip();
        saveIni("aedit.ini.js")  
    }   
}  
    
    
function setIna(elem) {
    elem.setAttribute("class", "prjIna");
}
    
function setAct(elem) {
    elem.setAttribute("class", "prjAct");
}     
    
function updateTooltip() {
    var tt = document.getElementById("listOfPrj");
    tt.innerHTML = "<h3>PROJECTS</h3>";
    for(var i=0; i < config.prjList.length;i++) {
        var title= config.prjList[i];
        var name = extractFile(title);
        tt.innerHTML += "<p class='prjIna' title='"+title+"' onmouseover='setAct(this)' onmouseout='setIna(this)' onclick='selectProject(this)'>" + name+"</p>";
    }
}

function prjCtxMenu(elem) {
    var x = document.getElementById('ctx1');
    if(x) x.parentNode.removeChild(x); 
  
    var parent = elem.parentNode; 
    var d = document.createElement('div');
    parent.appendChild(d);

    d.id = 'ctx1';
    d.className = 'prjctxm';
    var mx = elem.offsetLeft - elem.scrollLeft + elem.clientLeft + 32;
    var my = elem.offsetTop - elem.scrollTop + elem.clientTop +8;  
    d.style.left = mx + "px";
    d.style.top = my + "px";
    d.onmouseover = function(e) { 
        this.style.cursor = 'pointer'; 
    } 
    d.onclick = function(e) { 
        parent.removeChild(d);  
    }
    document.body.onclick = function(e) {
        try { parent.removeChild(d);}
        catch(e) {}   
    }
  
    var p = document.createElement('p');
    d.appendChild(p);
    p.innerHTML = "Remove"; 
    p.onclick=function() {
        var temp = currentInProject  
        currentInProject = elem.title
        removeFileFromPrj() 
        currentInProject = temp
        projectDisplay()
    };
  
    return false;
}

/* Project end */
   
    
function preview(openflag) {
    var a = { 
        'command': 'viewtext',
        'path': AEditFileName, 
        'open': openflag,
        'ext': ''
    };
    sendFromInterface(a)
}    
    

var lst=null;  
function goline(element) {
    if(lst != null) clearTimeout(lst);
    lst=setTimeout(function() {
        var lnum = element.value;
        element.value="";
        editor.gotoLine(lnum,0);
    }, 1500);
}


function quitSub() {
    saveProject();    
    saveIni("aedit.ini.js")  
    sendFromInterface({ 'command': 'quit' });
    setTimeout(function() { this.close();}, 100);
}    
    
function quit() {
    setActiveRow();
    if(!contentToSave) {
        quitSub();
        return
    }
    AESaveDialog(function(result) {
        if(result) {
            quitSub();
        }
    });
    return 
}    

/* Shell */

var origin;
function act(element) {
	var command = element.id;
	var temp;
	switch(command)
	{
		case "new":	      
            clearDoc();	
            break;
		case "load":	
			winload();
			break;            
		case "indent":		
            editor.indent();	
            break;	
		case "outdent":		
            editor.blockOutdent();	
            break;					
		case "cut": 
			editorMyClipboard = editor.getCopyText();
			editor.remove(); 
			break;	
		case "copy":	
		    editorMyClipboard = editor.getCopyText();
		    break;	
		case "paste":
		    editor.insert(editorMyClipboard);
		    break;	
		case "set":
		case "clear":
			break;
		case "save":
            origin = AEditFileName;
			save(true);
			break;
		case "find":
            editor.execCommand("find")
			break;
        case "replace":
            editor.execCommand("replace")
            break;
		case "next":	
			editor.findNext();
			break;
        case "top":
            editor.gotoLine(0,0)
            break;  
        case "bottom":
            editor.gotoLine(99990,0)
            break; 
		case "comment":
			var current = editor.session.getTextRange(editor.getSelectionRange());
			temp = "/*" + current + "*/";	
			editor.remove();
			editor.insert(temp);	
			break;  
        case "nocomment":
            var xy = editor.getCursorPosition()
            editor.find("*/", {start: xy})
            editor.replace("")
            editor.find("/*", {start: xy, backwards:true})
            editor.replace("")
            break;
		case "link":
			var current = editor.session.getTextRange(editor.getSelectionRange());
			temp = "<a href=''>" + current + "</a>";	
			editor.remove();
			editor.insert(temp);	
			break;            
		case "table":
			buildtable(editor);
			break;
		case "undo":
			editor.undo();
			break;	
		case "redo":
			editor.redo();
			break;	
        case "preview":
            preview(true);
            break;
        case "about":
            about()
            break;
		case "quit":
			quit();
			break;	
		default:
			alert("Unknown command " +command);
	}			
	editor.focus();
}

function changedStatus(status) {
	var chg = document.getElementById("changed");
	if(status)
		chg.src="images/changed.png";
	else
		chg.src="images/saved.png";		
    contentToSave = status;  
}

function editDoc(jobj) { 
    if(jobj.project instanceof Object)  {  
        project = jobj.project; 
        config.project = project.name
        addProject(project.name)
        updateTooltip();    
    }
        
    editor.session.setValue(jobj.content, -1);
    AEditFileName = jobj.filename;
    if(project instanceof Object) {
        if(indexInProject(AEditFileName) != -1) {
            config.active = AEditFileName;
        }
    }   
    displayFileName();
    var mode = "plain_text";
    if(jobj.ext in languageExt) {  
        mode = "ace/mode/" + languageExt[jobj.ext];
    }
    editor.getSession().setMode(mode); 
    var row = getActiveRow();   
    editor.scrollToLine(row);
    projectDisplay(); 
    changedStatus(false);
    config.dir=extractDir(AEditFileName);
    saveIni("aedit.ini.js");          
    editor.focus(); 
}
    
ipcRenderer.on("interface", (event, data) => {
    var jobj = JSON.parse(data);
    switch(jobj.type) {
    case "openDoc":    
        setActiveRow(); 
        if(aPanel.style.display=="block") {
            aPanel.style.display="none"    
            ePanel.style.display="block"    
        }
        if(!contentToSave) {
            editDoc(jobj)
            return
        } 
        // ask to cancel or replace, save before or not
        AESaveDialog(function(result) {
            if(result) editDoc(jobj)
            return
        });
        break
    case "openPrj":    
        project = jobj.project; 
        config.project = project.name
        saveIni("aedit.ini.js")  
        addProject(project.name)
        updateTooltip(); 
        projectDisplay();     
        break;   
    case 'confirm':
     	var answer = confirm(jobj.question);
        if(answer && jobj.command == "delprj") {
            removeProject(jobj.path);
        }
        break;             
    case "message": 
        alert(jobj.content)   
        break;
    case "notification":
    case "mouse":
        break;  
    case "status":  
        updateStatusBar(jobj.content);   
        break;    
    case "saved":
        displayFileName();
        changedStatus(false);   
        break;
    default:
        alert("Unknow message: " + jobj.type);
        break;    
    }
})

var lastPanel;
    
function about() {
	if(aPanel.style.display == "block") {
    	lastPanel.style.display="block"    
    	aPanel.style.display="none"
		return;
	}
    lastPanel.style.display="none"    
    aPanel.style.display="block"
}
    

function restartEditor() {
    if(ePanel != lastPanel) {
        lastPanel.style.display="none"    
        ePanel.style.display="block"
        lastPanel = ePanel    
    }
    editor.focus();
}

var AEditSyncPath = undefined
var AEditFileName = ""

function winload() {
    var loader = document.getElementById("loader")
    var fc = (loader.contentWindow || loader.contentDocument);
    lastPanel.style.display="none"
    aPanel.style.display="none"    
    lPanel.style.display="block"
    lastPanel = lPanel  
    fc.startLoader() 
    fc.setLoadPath(); 
    return true;
}

    
function load() {
    var a = { 
	    'command': 'getContent', 
		'path': AEditFileName,
        'project':""
    };
    sendFromInterface(a)
}  
    
function openProject(name, mode) {   
    saveProject()
    var a = { 
        'command': 'openPrj', 
        'name': name, 
        'mode': mode 
    };
    sendFromInterface(a)
}    
    

var winsave = function() {
    var newpath = dialog.showSaveDialog(null, {
        title:"Save current text in a file",
        defaultPath: AEditFileName,
        buttonLabel: "Save"
    })
    if(newpath != undefined && newpath.length > 0) return newpath;
    return "";  // abort
}

function option() {
    lastPanel = opanel
}

function getExtension(fname) {
    if(fname != undefined && fname != "") {
        var pos = fname.lastIndexOf(".")
        if(pos > 0) return fname.substr(pos)
    }
    return ""
}    
    
function save(winflag) {
    var nflag = AEditFileName == undefined || AEditFileName == "";
    if(winflag || nflag)  { 
        var x = winsave() 
        if(x == "") return;
        AEditFileName = x;
    }
    editor.focus();
    setActiveRow();
    let convert = false
    if(getExtension(origin)== ".md") {
        var tgtext = getExtension(AEditFileName)
        if(tgtext == ".html" || tgtext == ".xml" || tgtext == ".php") {
            convert = true  
        }
    }
    var content = editor.getValue();
    if(content.length == 0) return; 
    var a = { 
	    'command': 'save', 
        'filename': AEditFileName, 
		'content' : content,
        'convert' : convert,
        'origin'  : origin,
		'overwrite' : true 
    };
    sendFromInterface(a)
    preview(false)
    if(convert && origin != "") {
        AEditFileName = origin;
        origin = "";
    }
}   
    

function buildtable(editor) {
    var rows = 6;
    var cols = 4;
    if(rows > 0 && cols > 0) {
		var table = "<table><tbody>\n";
        table += "<thead><tr>";
		for (var j=0; j < cols; j++) {
            table += "<th></th>";
		}
		table += "</tr></thead>\n";
        table += "<tbody>\n";
		for (var i=1; i < rows; i++) {
			table += "<tr>";
			for (var j=0; j < cols; j++) {
				table += "<td></td>";
			}
			table += "</tr>\n";
		}
		table += "<tbody></table>\n";
		editor.insert(table);   
	}	
}


window.onload=function() {
    lastPanel = document.getElementById("epanel"); 
    display(null);
    updateTooltip();
    rootdir = __dirname;
    if(config.project == null) {
        return;
    }
    var pname = config.project
    openProject(pname, false);
}

</script>

</body>
</html>
